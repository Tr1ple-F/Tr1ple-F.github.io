<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">



<link rel="icon" type="image/ico" href="https://tr1ple-f.github.io//favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://tr1ple-f.github.io//favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://tr1ple-f.github.io//favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="https://tr1ple-f.github.io//android-chrome-192x192.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://tr1ple-f.github.io//apple-touch-icon.png">

<meta name="description" content=""/>



<title>
    
    Spring Boot, MongoDB and the Java DateTime API | Tr1ple-F&#39;s Blog
    
</title>

<link rel="canonical" href="https://tr1ple-f.github.io/posts/mongodb-spring-date-formats/"/>

<meta property="og:url" content="https://tr1ple-f.github.io/posts/mongodb-spring-date-formats/">
  <meta property="og:site_name" content="Tr1ple-F&#39;s Blog">
  <meta property="og:title" content="Spring Boot, MongoDB and the Java DateTime API">
  <meta property="og:description" content="A quick fix guide on how avoid java.util.Date">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-02-20T12:00:00+00:00">
    <meta property="article:modified_time" content="2025-02-20T12:00:00+00:00">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Date">
    <meta property="article:tag" content="Mongodb">
    <meta property="article:tag" content="Spring">













<link rel="stylesheet" href="/assets/combined.min.02176341f87674da2e49fdabffde02bd9b2630044293195c0b889898b62410fc.css" media="all">









</head>







<body class="auto">

  <div class="content">
    <header>
      

<div class="header">

    

    <h1 class="header-title">
        <a href="https://tr1ple-f.github.io/">Tr1ple-F&#39;s Blog</a>
    </h1>

    <div class="flex">
        

        
        
      
        <p class="small ">
            <a href="/" >
                /home
            </a>
        </p>
        
      
        <p class="small ">
            <a href="/posts" >
                /posts
            </a>
        </p>
        
        
    </div>

    

</div>

    </header>

    <main class="main">
      





<div class="breadcrumbs">
    
    <a href="/">Home</a>
    <span class="breadcrumbs-separator"> / </span>
    
    <a href="/posts/">Posts</a>
    <span class="breadcrumbs-separator"> / </span>
    
    <a href="/posts/mongodb-spring-date-formats/">Spring Boot, MongoDB and the Java DateTime API</a>
</div>



<div  class="autonumber" >

  <div class="single-intro-container">

    

    <h1 class="single-title">Spring Boot, MongoDB and the Java DateTime API</h1>
    
    <p class="single-summary">A quick fix guide on how avoid <code>java.util.Date</code></p>
    

    

    <p class="single-readtime">
      
      
      
      <time datetime="2025-02-20T12:00:00&#43;00:00">February 20, 2025</time>
      

      
      &nbsp; Â· &nbsp;
      3 min read
      
    </p>

  </div>

  

  

  
  <aside class="toc">
    <p><strong>Table of contents</strong></p>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#what--why">What &amp; Why?</a>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#the-issue">The Issue</a></li>
        <li><a href="#mongodb-codecs">MongoDB Codecs</a></li>
      </ul>
    </li>
    <li><a href="#the-fix">The Fix</a></li>
  </ul>
</nav>
  </aside>
  

  

  <div class="single-content">
    <h2 class="heading" id="what--why">
  What &amp; Why?
  <a class="anchor" href="#what--why">#</a>
</h2>
<h3 class="heading" id="background">
  Background
  <a class="anchor" href="#background">#</a>
</h3>
<p>In the techstack of my previous startup we used Java/Spring as our backend framework and MongoDB as database.
One of the reasons for choosing this stack was the security features provided by Spring (the headaches of which I will describe in a future post).
As for our database, we had a fairly flexible schema of documents we had to accommodate.</p>
<p>Take these two example documents:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;foo&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;time&#34;</span>: <span style="color:#e6db74">&#34;2020-01-01T12:00:00&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;params&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;foo&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;bar&#34;</span>: <span style="color:#e6db74">&#34;2024-01-01T12:00:00&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;bar&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;time&#34;</span>: <span style="color:#e6db74">&#34;2020-01-01T12:00:00&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;params&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;foo&#34;</span>: <span style="color:#e6db74">&#34;string&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;bar&#34;</span>: <span style="color:#e6db74">&#34;2021-01-01T12:00:00&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We were constrained by</p>
<ol>
<li>we couldn&rsquo;t fix the keys inside <code>params</code> from our application side</li>
<li>we couldn&rsquo;t fix the types of the keys ahead of time.</li>
</ol>
<p>Hence our Java code looked something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyDocument</span> {
</span></span><span style="display:flex;"><span>    String name;
</span></span><span style="display:flex;"><span>    LocalDateTime time;
</span></span><span style="display:flex;"><span>    Map<span style="color:#f92672">&lt;</span>String, Object<span style="color:#f92672">&gt;</span> params;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>where our backend code would rely on MongoDB to correctly serialize the <code>params</code> map which we would then process.</p>
<h3 class="heading" id="the-issue">
  The Issue
  <a class="anchor" href="#the-issue">#</a>
</h3>
<p>When serializing the <code>time</code> field, MongoDB would correctly parse the BSON representation to <code>LocalDateTime</code> (i.e. the JSR-310 <strong>Java 8 Date/Time API</strong>).
However, since MongoDB&rsquo;s default handling of <code>BSONType.DATE_TIME</code> is still <code>java.util.Date</code> our <code>params</code> map would contain objects of type <code>java.util.Date</code> which we would have to re-cast.
Naturally, this introduced many bugs and crashes on our end whenever we had some random <code>java.util.Date</code> object flying through our memory. Pretty much from the start of our project this bug bothered us
but we didn&rsquo;t manage to take care of it until almost 2.5 years later.</p>
<h3 class="heading" id="mongodb-codecs">
  MongoDB Codecs
  <a class="anchor" href="#mongodb-codecs">#</a>
</h3>
<p>The origin of this issue is how the Java MongoDB driver deals with codecs.
The MongoDB driver supports JSR-310 since version 3.7 <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>; however, documents get parsed as subparts depending on which codecs fits.
For fields this can happen completely independently of each other which means two fields could use completely different codecs.
The relevant class handles codec selection for BSON docuemnts is the <code>DocumentCodecProvider</code>.
It has a function <code>get(Class&lt;T&gt; clazz, CodecRegistry)</code> which determines the codecs that will be used throughout the encoding/decoding.
Naturally, MongoDB has a default configuration of how BSON types should be cast to Java types (e.g. <code>BSONType.DOUBLE</code> to <code>java.lang.Double</code>).
Since our Java declaration of <code>params</code> doesn&rsquo;t enforce any type restrictions, MongoDB will refer to the defaults provided through the <code>BsonTypeClassMap.DEFAULT_BSON_TYPE_CLASS_MAP</code>.
<a href="https://github.com/mongodb/mongo-java-driver/blob/fb3f30b79aecfa5b17404c33a29fb1f5fb6f4ffb/bson/src/main/org/bson/codecs/BsonTypeClassMap.java#L112">Here</a> we find the culprit: <code>BsonType.DATE_TIME</code> defaults to <code>Date.class</code>.
So to fix our problem we will have to tell MongoDB to use a different default codec and override the <code>CodecRegistry</code> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<h2 class="heading" id="the-fix">
  The Fix
  <a class="anchor" href="#the-fix">#</a>
</h2>
<p>To fix the issue, we added a class named <code>MongoConfig</code> to our application which configures the MongoDB BSON codec mapping.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> com.mongodb.MongoClientSettings;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.time.LocalDateTime;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Map;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.bson.BsonType;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.bson.codecs.BsonTypeClassMap;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.bson.codecs.DocumentCodecProvider;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.bson.codecs.configuration.CodecRegistries;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.bson.codecs.pojo.PojoCodecProvider;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.boot.autoconfigure.mongo.MongoClientSettingsBuilderCustomizer;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Bean;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> org.springframework.context.annotation.Configuration;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * Configuration class for MongoDB.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MongoConfig</span> {  
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Custom {@link MongoClientSettings} to decode {@link BsonType#DATE_TIME} to {@link LocalDateTime}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return the customized settings builder
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> MongoClientSettingsBuilderCustomizer <span style="color:#a6e22e">mongoClientSettingsBuilderCustomizer</span>() {
</span></span><span style="display:flex;"><span>        BsonTypeClassMap classMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BsonTypeClassMap(Map.<span style="color:#a6e22e">of</span>(BsonType.<span style="color:#a6e22e">DATE_TIME</span>, LocalDateTime.<span style="color:#a6e22e">class</span>));  
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> builder <span style="color:#f92672">-&gt;</span> builder.<span style="color:#a6e22e">codecRegistry</span>(CodecRegistries.<span style="color:#a6e22e">fromRegistries</span>(  
</span></span><span style="display:flex;"><span>            CodecRegistries.<span style="color:#a6e22e">fromProviders</span>(<span style="color:#66d9ef">new</span> DocumentCodecProvider(classMap)),                <span style="color:#75715e">// (1)</span>
</span></span><span style="display:flex;"><span>            MongoClientSettings.<span style="color:#a6e22e">getDefaultCodecRegistry</span>(),                                     <span style="color:#75715e">// (2)</span>
</span></span><span style="display:flex;"><span>            CodecRegistries.<span style="color:#a6e22e">fromProviders</span>(PojoCodecProvider.<span style="color:#a6e22e">builder</span>().<span style="color:#a6e22e">automatic</span>(<span style="color:#66d9ef">true</span>).<span style="color:#a6e22e">build</span>()) <span style="color:#75715e">// (3)</span>
</span></span><span style="display:flex;"><span>        ));  
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The most important element here is the <code>classMap</code>.
This map overrides the previously mentioned <code>DEFAULT_BSON_TYPE_CLASS_MAP</code> and enforces general use of the <code>LocalDateTimeCodec</code> class and even when casting to <code>Object</code> MongoDB will default to instantiate the object as <code>LocalDateTime</code>.
The three codec registries are responsible for (1) overriding the default date handling (2) refering otherwise to default codecs (3) providing a codec when casting to custom Java POJOs.
Once setup the Spring bean injection will make sure MongoDB is appropriately configured.</p>
<hr>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://mongodb.github.io/mongo-java-driver/3.7/whats-new/#jsr-310-instant-localdate-localdatetime-support">https://mongodb.github.io/mongo-java-driver/3.7/whats-new/#jsr-310-instant-localdate-localdatetime-support</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://www.mongodb.com/docs/drivers/java/sync/current/faq/#can-i-serialize-a-java.util.date-as-a-string-in-format-yyyy-mm-dd-">https://www.mongodb.com/docs/drivers/java/sync/current/faq/#can-i-serialize-a-java.util.date-as-a-string-in-format-yyyy-mm-dd-</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    
  </div>

  

  

  
  

  

  

  
  <div class="back-to-top">
    <a href="#top">
      back to top
    </a>
  </div>
  

</div>


    </main>
  </div>

  <footer>
    

    
    <p>Powered by
        <a href="https://gohugo.io/">Hugo</a>
        and
        <a href="https://github.com/tomfran/typo">tomfran/typo</a>
    </p>
    
    
    


  </footer>

  
  <link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
<script defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>

<script defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js"
  onload="renderMathInElement(document.body);"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false }
      ]
    });
  });
</script>
  

</body>

<script src="/js/theme-switch.js"></script>
<script defer src="/js/copy-code.js"></script>
</html>
